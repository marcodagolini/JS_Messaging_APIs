
<style>
.LEE_BOARD_ITEM,.lp-panel-body,.lp-panel-heading{cursor:pointer!important;text-align:center!important}.LEE_BOARD_ITEM,.lp-panel-body,.lp-panel-group,.lp-panel-heading{text-align:center!important}.LEE_BOARD_ITEM{border-top:2px #ebf3fb solid!important;padding:4px!important;margin-top:2px!important;vertical-align:middle!important}hr.le-divider{background-color:#bababa!important;height:1px!important;border:1px!important;margin:2px!important}.lp-panel-group{font-family:Verdana,Geneva,sans-serif!important;font-size:13px!important;height:100%!important;white-space:nowrap!important;margin-left:6px!important;margin-right:6px!important;display:-webkit-box!important;display:-moz-box!important;display:-webkit-flexbox!important;display:-ms-flexbox!important;display:-webkit-flex!important;display:flex!important}.lp-panel-default{border:1px solid #cacaca!important;background-color:#FAFAFA!important;display:inline-block!important}.lp-panel-heading{margin:3px!important;max-height:111px!important}.lp-panel-body{overflow:hidden!important;color:#1178D9!important;padding:.66rem!important;flex:1!important;border-top:1px solid #dadada!important;border-bottom:1px solid #dadada!important}.lp-panel a:hover{background-color:#c1c1c1!important;text-decoration:none!important}.lp-panel-text{text-align:left!important;padding:.25rem!important;word-wrap:break-word!important;white-space:normal!important}.lp-title-text{font-size:15px!important}.lp-type-text{font-size:13px!important;color:#999!important}.lp-bold-text{padding-top:.5rem!important;font-weight:700!important}.lp-panel-heading>img{width:auto!important;max-width:70%!important;height:100%!important;max-height:111px!important}hr{margin:0!important!important}
</style>


<script>
"use strict";function initVisitor(){function e(){var e=a.querySelector("#textline");l&&l.disconnect(),e?l=t(e):console.warn("no chat line container available")}function t(e){function t(){for(var t=e.querySelectorAll(a),l=0;l<t.length;l++){var i=t[l];i.classList.add("LEE_TREATED");var n=i.querySelector("#textline");0!==n.children.length&&3!==n.firstChild.nodeType&&(n=n.firstChild);var r=n&&n.textContent?n.textContent:n.innerText?n.innerText:"";if(0===r.indexOf("@@LP@@{")){u=r.substring("@@LP@@".length,r.lastIndexOf("}")+1);try{if(n.classList.add("LEE_BOARD_LINE"),u=JSON.parse(u),n.innerText=u.content,(y=document.createElement("div")).classList.add("lp-panel-group"),y.style.width=220*u.boards.length+"px",u.boards){for(var s=0;s<u.boards.length;s++){var o=u.boards[s],d=document.createElement("div");d.classList.add("lp-panel"),d.classList.add("lp-panel-default"),y.appendChild(d),d.style.border="1px solid #cacaca",d.style.backgroundColor="#FAFAFA",d.style.clear="both",d.style.width="220px",d.style.textAlign="center",d.style.whiteSpace="nowrap",0==s&&(d.style.borderTopLeftRadius="4px",d.style.borderBottomLeftRadius="4px"),s==u.boards.length-1&&(d.style.borderTopRightRadius="4px",d.style.borderBottomRightRadius="4px");for(var c=document.createElement("div"),l=0;l<o.length;l++){var p=o[l];if("img"===p.type)c.innerHTML=p.data.imageUrl?"<img src='"+p.data.imageUrl+"'>":"",c.classList.add("lp-panel-heading"),c.style.textAlign="center",d.appendChild(c);else if("btn"===p.type){h=p.data.text.length>20?p.data.text.substring(0,20)+"...":p.data.text;d.innerHTML=d.innerHTML+'<div class="lp-panel-body" title="'+p.data.text+'"   onclick="console.log(this.title); (document.getElementsByClassName(\'lpview_form_textarea\')[0]).value = this.title; return false;">'+h+"</div>"}else if("map"===p.type){var h=p.data.text.length>20?p.data.text.substring(0,20)+"...":p.data.text;c.innerHTML="<a target='_blank' href='https://www.google.com/maps/place//@"+p.data.latitude+","+p.data.longitude+",14z/'><img src='https://maps.googleapis.com/maps/api/staticmap?center="+p.data.latitude+","+p.data.longitude+"&markers=color:blue%7Clabel:A%7C"+p.data.latitude+","+p.data.longitude+"&zoom=14&size=167x111&key=AIzaSyD0FAiv_la9dq8c70_ETYu1i-eoaJktNEo' style='width:auto;height:90%;max-height:111px;'></a>",c.classList.add("lp-panel-heading"),c.style.textAlign="center",d.appendChild(c),d.innerHTML=d.innerHTML+'<div class="lp-panel-body" title="'+p.data.text+'"  onclick="console.log(this.title);  (document.getElementsByClassName(\'lpview_form_textarea\')[0]).value = this.title; return false;">'+h+"</div>"}}}(v=document.createElement("div")).appendChild(y),v.style.maxWidth="260px",v.style.overflowX="auto",v.style.whiteSpace="nowrap",v.style.height="auto",(x=document.createElement("div")).appendChild(v),i.insertAdjacentHTML("afterend",x.innerHTML)}}catch(e){console.error(e),n.innerText="Error processing content"}}if(0===r.indexOf("lpsc:{")){var u=r.substring("lpsc:".length,r.lastIndexOf("}")+1);try{n.classList.add("LEE_BOARD_LINE"),u=JSON.parse(u).layout;var y=document.createElement("div");y.classList.add("lp-panel-group"),n.innerText="";if(u.hasOwnProperty("type")&&u.hasOwnProperty("elements")&&"verticalhorizontal".indexOf(u.type)>-1){function g(e,t){var a=document.createElement("div");a.classList.add("lp-panel"),a.classList.add("lp-panel-default"),t.appendChild(a),a.style.border="1px solid #cacaca",a.style.backgroundColor="#FAFAFA",a.style.clear="both",a.style.width="220px",a.style.textAlign="center",a.style.whiteSpace="nowrap";for(var l=-1,i=0;i<e.length;i++){var n=e[i];0==++l&&(a.style.borderTopLeftRadius="4px",a.style.borderBottomLeftRadius="4px"),l==e.length-1&&(a.style.borderTopRightRadius="4px",a.style.borderBottomRightRadius="4px");var r=document.createElement("div"),s=document.createElement("div");if(n.hasOwnProperty("type"))switch(n.type){case"vertical":g(n.elements,r);break;case"horizontal":console.error("le_enh_vis:: Horizontal subgroups not allowed!");break;case"linkPreview":s.innerHTML="<div><a href='"+n.url+"'>"+n.title+"</a></div>",(s=s.firstChild).style.textAlign="center";break;case"map":s.innerHTML="<div><img src='https://maps.googleapis.com/maps/api/staticmap?center="+n.la+","+n.lo+"&markers=color:blue%7Clabel:A%7C"+n.la+","+n.lo+"&zoom=14&size=167x111&key=AIzaSyD0FAiv_la9dq8c70_ETYu1i-eoaJktNEo' style='width:auto;height:90%;max-height:111px;'></div>",(s=s.firstChild).classList.add("lp-panel-heading"),s.style.textAlign="center";break;case"button":var o=n.title?n.title.length>20?n.title.substring(0,20)+"...":n.title:"";s.innerHTML='<div style="text-align:center;" title="'+n.title+'"   ">'+o+"</div>",s=s.firstChild,r.classList.add("lp-panel-body");break;case"text":for(var d='style ="',c=0;c<Object.keys(n.style).length;c++){var p=Object.keys(n.style)[c];n.style.hasOwnProperty(p)&&(d+=p+": "+n.style[p]+" !important; ")}d+='";',s.innerHTML='<div class="lp-panel-text" '+d+' title="'+n.text+'">'+n.text+"</div>",s=s.firstChild;break;case"image":s.innerHTML=n.url?"<div><img src='"+n.url+"'></div>":"<img />",(s=s.firstChild).classList.add("lp-panel-heading"),s.style.textAlign="center"}if(n.hasOwnProperty("action")&&n.action.hasOwnProperty("type")){switch(n.action.type){case"link":r.innerHTML=linkOut(n.action.uri);break;case"publishText":r.innerHTML=publishTextData(n.action.text);break;case"navigate":r.innerHTML=navigate(n.action.la,n.action.lo)}r.firstChild.appendChild(s)}else r.appendChild(s);a.appendChild(r)}}if("horizontal"===u.type){y.style.width=220*u.elements.length+"px";for(var m=0;m<u.elements.length;m++)g([u.elements[m]],y)}else y.style.width="220px",g(u.elements,y)}var v=document.createElement("div");v.appendChild(y),v.style.maxWidth="260px",v.style.overflowX="auto",v.style.whiteSpace="nowrap",v.style.height="auto",v.title=u.id;var x=document.createElement("div");x.appendChild(v),i.insertAdjacentHTML("afterend",x.innerHTML),i.querySelector("#textline").style.display="none",i.querySelector("#textline").style.display="none",i.querySelector("#textline").style.display="none"}catch(e){console.error(e),n.innerText="Error processing content"}}}}var a=".lp_chat_line_wrapper.lp_agent:not(.LEE_TREATED)",l=new MutationObserver(t);return l.observe(e,{childList:!0,subtree:!0}),t(),l}var a=document.querySelector("#textline");if(!a)return setTimeout(initVisitor,800);var l=null;new MutationObserver(function(t){e()}).observe(a,{childList:!0}),e()}var publishText="<div onclick=\"console.log(this.firstChild.title); (document.getElementsByClassName('lpview_form_textarea')[0]).value = this.firstChild.title; return false;\" ></div>",publishTextData=function(e){var t=e.replace(/'/gi,"\\'");return"<div onclick=\"console.log('"+t+"'); (document.getElementsByClassName('lpview_form_textarea')[0]).value = '"+t+"'; return false;\" ></div>"},linkOut=function(e){return'<a href="'+e+'" target="_blank"></a>'},navigate=function(e,t){return"<a target='_blank' href="+("https://www.google.com/maps/place//@"+e+","+t+",14z/")+"></a>"},populateField=function(){document.getElementsByClassName("lpview_form_textarea")[0].value=this.innerText};initVisitor();
</script>




<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>


<div style="position:absolute; background-image: url(https://i.imgur.com/b54DM6d.png); height: 607px; width: 312px;">
<div style="position:relative; left: 30px; top: 75px;">
 <textarea id="log" style="position:absolute; left: -1px; top: 0px; resize: none; width: 256px;
 height: 420px; font-size: 1em;"></textarea>
<form class="form-inline" onsubmit="return false" style="position:relative; left: 0px; top: 430px;">
    <div class="form-group" style="display:inline;">
         <label for="textline"></label>
         <input id="textline" type="text" class="form-control" style="border: none; width: 190px;
 height: 24px; font-size: 1em;">
    </div>
    <button id="send" class="btn btn-default" disabled>invia</button>

    <div class="form-group" style="display:none;">
        <label for="account">Account:</label>
        <input id="account" type="text" class="form-control" value="64096141">
    </div>
   
    <button id="connect" class="btn btn-default" style="display:none;">connect</button>
 </form>
</div>
</div>


<script>

"use strict";



function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var LPUtils = function () {
  function LPUtils() {
    _classCallCheck(this, LPUtils);
  }

  LPUtils.getDomain = function getDomain(account, name) {
    var domains = account.startsWith("le") ? "hc1n.dev.lprnd.net" : "adminlogin.liveperson.net";
    return new Promise(function (res, rej) {
      return $.ajax({
        url: "https://" + domains + "/csdr/account/" + account + "/service/" + name + "/baseURI.lpCsds?version=1.0",
        jsonp: "cb",
        jsonpCallback: "domainCallback",
        cache: true,
        dataType: "jsonp",
        success: function success(data) {
          return res(data.ResultSet.lpData[0].lpServer);
        },
        error: function error(e, text) {
          return rej(text);
        }
      });
    });
  };

  LPUtils.agentProfile = function agentProfile(account, agentID) {
    var _this = this;

    return new Promise(function (res, rej) {
      return _this.getDomain(account, "acCdnDomain").then(function (accdnDomain) {
        return $.ajax({
          url: "https://" + accdnDomain + "/api/account/" + account + "/configuration/le-users/users/" + agentID,
          jsonp: "cb",
          jsonpCallback: "apCallback",
          cache: true,
          dataType: "jsonp",
          success: function success(accdnResp) {
            return res(accdnResp);
          }
        });
      });
    });
  };

  LPUtils.signup = function signup(account) {
    var _this2 = this;

    return new Promise(function (res, rej) {
      return _this2.getDomain(account, "idp").then(function (idpDomain) {
        return $.ajax({
          url: "https://" + idpDomain + "/api/account/" + account + "/signup.jsonp",
          jsonp: "callback",
          dataType: "jsonp",
          success: function success(idpResp) {
            return res(idpResp.jwt);
          }
        });
      });
    });
  };

  // fetch jwt from localstorage or create one

  LPUtils.getJWT = function getJWT(account) {
    var localJWT = localStorage.getItem(account + "-jwt");
    if (localJWT) return Promise.resolve(localJWT);else return this.signup(account).then(function (newJWT) {
      localStorage.setItem(account + "-jwt", newJWT);
      return Promise.resolve(newJWT);
    });
  };

  LPUtils.clearJWT = function clearJWT(account) {
    localStorage.removeItem(account + "-jwt");
  };

  return LPUtils;
}();
// LPUtils.getDomain("qa20971604", "idp").then(r => console.log(r));
// LPUtils.signup("qa20971604").then(r => console.log(r));

var LPWs = function () {
  LPWs.connect = function connect(url) {
    return new LPWs(url)._connect();
  };

  LPWs.connectDebug = function connectDebug(url) {
    return new LPWs(url, true)._connect();
  };

  function LPWs(url, debug) {
    _classCallCheck(this, LPWs);

    this.reqs = {};
    this.subs = [];
    this.url = url;
    this.debug = debug;
  }

  LPWs.prototype._connect = function _connect() {
    var _this3 = this;

    return new Promise(function (resolve, reject) {
      var ws = new WebSocket(_this3.url);
      _this3.ws = ws;
      ws.onopen = function () {
        return resolve(_this3);
      };
      ws.onmessage = function (msg) {
        return _this3.onmessage(msg);
      };
      ws.onclose = function (evt) {
        _this3.ws = null;
        reject(evt);
      };
    });
  };

  LPWs.prototype.request = function request(type, body, headers) {
    var _this4 = this;

    return new Promise(function (resolve, reject) {
      var obj = {
        "kind": "req",
        "type": type,
        "body": body || {},
        "id": Math.floor(Math.random() * 1e9),
        "headers": headers
      };
      _this4.reqs[obj.id] = function (type, code, body) {
        return resolve({
          type: type,
          code: code,
          body: body
        });
      };
      var str = JSON.stringify(obj);
      if (_this4.debug) console.log("sending: " + str);
      _this4.ws.send(str);
    });
  };

  LPWs.prototype.onNotification = function onNotification(filterFunc, _onNotification) {
    this.subs.push({
      filter: filterFunc,
      cb: _onNotification
    });
  };

  LPWs.prototype.toFuncName = function toFuncName(reqType) {
    var str = reqType.substr(1 + reqType.lastIndexOf('.'));
    return str.charAt(0).toLowerCase() + str.slice(1);
  };

  LPWs.prototype.registerRequests = function registerRequests(arr) {
    var _this5 = this;

    arr.forEach(function (reqType) {
      return _this5[_this5.toFuncName(reqType)] = function (body, headers) {
        return _this5.request(reqType, body, headers);
      };
    });
  };

  LPWs.prototype.onmessage = function onmessage(msg) {
    if (this.debug) console.log("recieved: " + msg.data);
    var obj = JSON.parse(msg.data);
    if (obj.kind == "resp") {
      var id = obj.reqId;
      delete obj.reqId;
      delete obj.kind;
      this.reqs[id].call(this, obj.type, obj.code, obj.body);
      delete this.reqs[id];
    } else if (obj.kind == "notification") {
      this.subs.forEach(function (sub) {
        if (sub.filter.call(this, obj)) {
          sub.cb.call(this, obj.body);
        };
      });
    }
  };

  return LPWs;
}();

// LPWs.connect("wss://echo.websocket.org").then(lpws => console.log(`lpws was opened.`));

</script>













<script>

$(document).ready(() => {
  prepareToConnect();
  $('#connect').click();  
});

function prepareToConnect() {
  $('#connect').text('connect').unbind('click').click(() => {
    $('#connect').text('connecting...');
    const account = $('#account').prop('disabled',true).val();
    LPUtils.getJWT(account).then(jwt => {
      LPUtils.getDomain(account, 'asyncMessagingEnt').then(umsDomain => {
        LPWs.connect(`wss://${umsDomain}/ws_api/account/${account}/messaging/consumer?v=3`)
        .then(
          openedSocket => handleOpenedSocket(openedSocket,jwt), 
          errorOpening => {
            $('#log').append(`error opening connection ${errorOpening}\n`);
            prepareToConnect();
          });
      });
    }, errorGettingJwt => {
      $('#connect').text('connect');
      $('#account').prop('disabled',false).val();      
      $('#log').append(`error ${errorGettingJwt} getting jwt for account ${account}\n`);
    });
  });
}

function handleOpenedSocket(socket,jwt) {
  $('#log').html(`\nBenvenuti nel nuovo servizio di Messaging asincrono di Vodafone.\n\nI nostri Agenti saranno presto disponibili.\n`);
  socket.registerRequests(apiRequestTypes);

  const me = myId(jwt);
  
  socket.initConnection({},[{ "type": ".ams.headers.ConsumerAuthentication", "jwt": jwt}]);
  socket.onNotification(withType('MessagingEvent'),
    body => body.changes.forEach(change => {
      switch (change.event.type) {
        case 'ContentEvent':
          $('#log').append(`${change.originatorId===me? 'Tu':'Agente'}: ${change.event.message}\n`);
          var textarea = document.getElementById('log');
          textarea.scrollTop = textarea.scrollHeight;
      }
    }));

  // subscribe to open conversations metadata
  socket.subscribeExConversations({
    'convState': ['OPEN']
  }).then(resp => {
    var openConvs = {};
    socket.onNotification(withSubscriptionID(resp.body.subscriptionId),
      (notificationBody) => handleConversationNotification(socket,notificationBody,openConvs));

    $('#send').prop('disabled', false).click(() => {
      if (Object.keys(openConvs)[0]) {
        publishTo(socket,Object.keys(openConvs)[0]);
      } else  {
        socket.consumerRequestConversation()
          .then(resp => publishTo(socket,resp.body.conversationId));
      }
    });
    $('#close').prop('disabled', false).click(() => {
      if (Object.keys(openConvs)[0]) {
        socket.updateConversationField({
            conversationId: Object.keys(openConvs)[0],
            conversationField: [{
                    field: "ConversationStateField",
                    conversationState: "CLOSE"
                }]
        });
      }
    });
  });

  $('#connect').text('disconnect').unbind('click').click(() => socket.ws.close());
  socket.ws.onclose = (evt) => onCloseSocket(socket,evt);
}

function handleConversationNotification(socket,notificationBody,openConvs) {
  notificationBody.changes.forEach(change => {
    if (change.type === 'UPSERT') {
      if (!openConvs[change.result.convId]) {
        openConvs[change.result.convId] = change.result;
        socket.subscribeMessagingEvents({
          fromSeq: 0,
          dialogId: change.result.convId
        });
      }
    } else if (change.type === 'DELETE') {
      delete openConvs[change.result.convId];
      $('#log').append(`La conversazione e' stata chiusa.\n`);
    }
  });
}

function onCloseSocket(socket,evt) {
  socket.ws = null;
  // $('#log').append(`connection was closed with code ${evt.code}\n`);
  prepareToConnect();
  $('#send').prop('disabled', true).unbind('click');
  $('#account').prop('disabled',false).val();
  $('#connect').click();        
}

function publishTo(socket,convID) {
  socket.publishEvent({
    dialogId: convID,
    event: {
      type: 'ContentEvent',
      contentType: 'text/plain',
      message: $('#textline').val()
    }
  })
  .then(resp => $('#textline').val(''));
}

function withSubscriptionID(subscriptionID) {
  return notif => notif.body.subscriptionId === subscriptionID;
}

function withType(type) {
  return notif => notif.type.includes(type);
}

function myId(jwt) {
  return JSON.parse(atob(jwt.split('.')[1])).sub;
}

const apiRequestTypes = ['cqm.SubscribeExConversations','ms.PublishEvent','cm.ConsumerRequestConversation','ms.SubscribeMessagingEvents','InitConnection','cm.UpdateConversationField'];


</script>
