<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>


<div style="position:absolute; background-image: url(https://i.imgur.com/b54DM6d.png); height: 607px; width: 312px;">
<div style="position:relative; left: 30px; top: 75px;">
 <textarea id="log" style="position:absolute; left: -1px; top: 0px; resize: none; width: 256px;
 height: 420px; font-size: 1em;"></textarea>
<form class="form-inline" onsubmit="return false" style="position:relative; left: 0px; top: 430px;">
    <div class="form-group" style="display:inline;">
         <label for="textline"></label>
         <input id="textline" type="text" class="form-control" style="width: 200px;
 height: 24px; font-size: 1em;">
    </div>
    <button id="send" class="btn btn-default" disabled>invia</button>

    <div class="form-group" style="display:none;">
        <label for="account">Account:</label>
        <input id="account" type="text" class="form-control" value="64096141">
    </div>
   
    <button id="connect" class="btn btn-default" style="display:none;">connect</button>
 </form>
</div>
</div>


<script>

"use strict";



function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var LPUtils = function () {
  function LPUtils() {
    _classCallCheck(this, LPUtils);
  }

  LPUtils.getDomain = function getDomain(account, name) {
    var domains = account.startsWith("le") ? "hc1n.dev.lprnd.net" : "adminlogin.liveperson.net";
    return new Promise(function (res, rej) {
      return $.ajax({
        url: "https://" + domains + "/csdr/account/" + account + "/service/" + name + "/baseURI.lpCsds?version=1.0",
        jsonp: "cb",
        jsonpCallback: "domainCallback",
        cache: true,
        dataType: "jsonp",
        success: function success(data) {
          return res(data.ResultSet.lpData[0].lpServer);
        },
        error: function error(e, text) {
          return rej(text);
        }
      });
    });
  };

  LPUtils.agentProfile = function agentProfile(account, agentID) {
    var _this = this;

    return new Promise(function (res, rej) {
      return _this.getDomain(account, "acCdnDomain").then(function (accdnDomain) {
        return $.ajax({
          url: "https://" + accdnDomain + "/api/account/" + account + "/configuration/le-users/users/" + agentID,
          jsonp: "cb",
          jsonpCallback: "apCallback",
          cache: true,
          dataType: "jsonp",
          success: function success(accdnResp) {
            return res(accdnResp);
          }
        });
      });
    });
  };

  LPUtils.signup = function signup(account) {
    var _this2 = this;

    return new Promise(function (res, rej) {
      return _this2.getDomain(account, "idp").then(function (idpDomain) {
        return $.ajax({
          url: "https://" + idpDomain + "/api/account/" + account + "/signup.jsonp",
          jsonp: "callback",
          dataType: "jsonp",
          success: function success(idpResp) {
            return res(idpResp.jwt);
          }
        });
      });
    });
  };

  // fetch jwt from localstorage or create one

  LPUtils.getJWT = function getJWT(account) {
    var localJWT = localStorage.getItem(account + "-jwt");
    if (localJWT) return Promise.resolve(localJWT);else return this.signup(account).then(function (newJWT) {
      localStorage.setItem(account + "-jwt", newJWT);
      return Promise.resolve(newJWT);
    });
  };

  LPUtils.clearJWT = function clearJWT(account) {
    localStorage.removeItem(account + "-jwt");
  };

  return LPUtils;
}();
// LPUtils.getDomain("qa20971604", "idp").then(r => console.log(r));
// LPUtils.signup("qa20971604").then(r => console.log(r));

var LPWs = function () {
  LPWs.connect = function connect(url) {
    return new LPWs(url)._connect();
  };

  LPWs.connectDebug = function connectDebug(url) {
    return new LPWs(url, true)._connect();
  };

  function LPWs(url, debug) {
    _classCallCheck(this, LPWs);

    this.reqs = {};
    this.subs = [];
    this.url = url;
    this.debug = debug;
  }

  LPWs.prototype._connect = function _connect() {
    var _this3 = this;

    return new Promise(function (resolve, reject) {
      var ws = new WebSocket(_this3.url);
      _this3.ws = ws;
      ws.onopen = function () {
        return resolve(_this3);
      };
      ws.onmessage = function (msg) {
        return _this3.onmessage(msg);
      };
      ws.onclose = function (evt) {
        _this3.ws = null;
        reject(evt);
      };
    });
  };

  LPWs.prototype.request = function request(type, body, headers) {
    var _this4 = this;

    return new Promise(function (resolve, reject) {
      var obj = {
        "kind": "req",
        "type": type,
        "body": body || {},
        "id": Math.floor(Math.random() * 1e9),
        "headers": headers
      };
      _this4.reqs[obj.id] = function (type, code, body) {
        return resolve({
          type: type,
          code: code,
          body: body
        });
      };
      var str = JSON.stringify(obj);
      if (_this4.debug) console.log("sending: " + str);
      _this4.ws.send(str);
    });
  };

  LPWs.prototype.onNotification = function onNotification(filterFunc, _onNotification) {
    this.subs.push({
      filter: filterFunc,
      cb: _onNotification
    });
  };

  LPWs.prototype.toFuncName = function toFuncName(reqType) {
    var str = reqType.substr(1 + reqType.lastIndexOf('.'));
    return str.charAt(0).toLowerCase() + str.slice(1);
  };

  LPWs.prototype.registerRequests = function registerRequests(arr) {
    var _this5 = this;

    arr.forEach(function (reqType) {
      return _this5[_this5.toFuncName(reqType)] = function (body, headers) {
        return _this5.request(reqType, body, headers);
      };
    });
  };

  LPWs.prototype.onmessage = function onmessage(msg) {
    if (this.debug) console.log("recieved: " + msg.data);
    var obj = JSON.parse(msg.data);
    if (obj.kind == "resp") {
      var id = obj.reqId;
      delete obj.reqId;
      delete obj.kind;
      this.reqs[id].call(this, obj.type, obj.code, obj.body);
      delete this.reqs[id];
    } else if (obj.kind == "notification") {
      this.subs.forEach(function (sub) {
        if (sub.filter.call(this, obj)) {
          sub.cb.call(this, obj.body);
        };
      });
    }
  };

  return LPWs;
}();

// LPWs.connect("wss://echo.websocket.org").then(lpws => console.log(`lpws was opened.`));

</script>













<script>

$(document).ready(() => {
  prepareToConnect();
  $('#connect').click();  
});

function prepareToConnect() {
  $('#connect').text('connect').unbind('click').click(() => {
    $('#connect').text('connecting...');
    const account = $('#account').prop('disabled',true).val();
    LPUtils.getJWT(account).then(jwt => {
      LPUtils.getDomain(account, 'asyncMessagingEnt').then(umsDomain => {
        LPWs.connect(`wss://${umsDomain}/ws_api/account/${account}/messaging/consumer?v=3`)
        .then(
          openedSocket => handleOpenedSocket(openedSocket,jwt), 
          errorOpening => {
            $('#log').append(`error opening connection ${errorOpening}\n`);
            prepareToConnect();
          });
      });
    }, errorGettingJwt => {
      $('#connect').text('connect');
      $('#account').prop('disabled',false).val();      
      $('#log').append(`error ${errorGettingJwt} getting jwt for account ${account}\n`);
    });
  });
}

function handleOpenedSocket(socket,jwt) {
  $('#log').html(`\nBenvenuti nel nuovo servizio di Messaging asincrono di Vodafone.\n\nI nostri Agenti saranno presto disponibili.\n`);
  socket.registerRequests(apiRequestTypes);

  const me = myId(jwt);
  
  socket.initConnection({},[{ "type": ".ams.headers.ConsumerAuthentication", "jwt": jwt}]);
  socket.onNotification(withType('MessagingEvent'),
    body => body.changes.forEach(change => {
      switch (change.event.type) {
        case 'ContentEvent':
          $('#log').append(`${change.originatorId===me? 'Tu':<img contenteditable="false" style="width:45px" id="myimg" src="data:image/png;base64,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">' Agente'}: ${change.event.message}\n`);
          var textarea = document.getElementById('log');
          textarea.scrollTop = textarea.scrollHeight;
      }
    }));

  // subscribe to open conversations metadata
  socket.subscribeExConversations({
    'convState': ['OPEN']
  }).then(resp => {
    var openConvs = {};
    socket.onNotification(withSubscriptionID(resp.body.subscriptionId),
      (notificationBody) => handleConversationNotification(socket,notificationBody,openConvs));

    $('#send').prop('disabled', false).click(() => {
      if (Object.keys(openConvs)[0]) {
        publishTo(socket,Object.keys(openConvs)[0]);
      } else  {
        socket.consumerRequestConversation()
          .then(resp => publishTo(socket,resp.body.conversationId));
      }
    });
    $('#close').prop('disabled', false).click(() => {
      if (Object.keys(openConvs)[0]) {
        socket.updateConversationField({
            conversationId: Object.keys(openConvs)[0],
            conversationField: [{
                    field: "ConversationStateField",
                    conversationState: "CLOSE"
                }]
        });
      }
    });
  });

  $('#connect').text('disconnect').unbind('click').click(() => socket.ws.close());
  socket.ws.onclose = (evt) => onCloseSocket(socket,evt);
}

function handleConversationNotification(socket,notificationBody,openConvs) {
  notificationBody.changes.forEach(change => {
    if (change.type === 'UPSERT') {
      if (!openConvs[change.result.convId]) {
        openConvs[change.result.convId] = change.result;
        socket.subscribeMessagingEvents({
          fromSeq: 0,
          dialogId: change.result.convId
        });
      }
    } else if (change.type === 'DELETE') {
      delete openConvs[change.result.convId];
      $('#log').append(`La conversazione e' stata chiusa.\n`);
    }
  });
}

function onCloseSocket(socket,evt) {
  socket.ws = null;
  // $('#log').append(`connection was closed with code ${evt.code}\n`);
  prepareToConnect();
  $('#send').prop('disabled', true).unbind('click');
  $('#account').prop('disabled',false).val();
  $('#connect').click();        
}

function publishTo(socket,convID) {
  socket.publishEvent({
    dialogId: convID,
    event: {
      type: 'ContentEvent',
      contentType: 'text/plain',
      message: $('#textline').val()
    }
  })
  .then(resp => $('#textline').val(''));
}

function withSubscriptionID(subscriptionID) {
  return notif => notif.body.subscriptionId === subscriptionID;
}

function withType(type) {
  return notif => notif.type.includes(type);
}

function myId(jwt) {
  return JSON.parse(atob(jwt.split('.')[1])).sub;
}

const apiRequestTypes = ['cqm.SubscribeExConversations','ms.PublishEvent','cm.ConsumerRequestConversation','ms.SubscribeMessagingEvents','InitConnection','cm.UpdateConversationField'];


</script>
